// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/utils/htmlToSvg/supportClasses/imageUtils/ImageOptimizer",["dojo/when","dojo/promise/all","../../../ImageUtil"],function(k,l,n){var m={},p=/["']data:image.*?["']/ig,r={analyze:function(f,c){var g=0,d=0,h=0,q=f.map(function(a){var e={text:a,images:(a.match(p)||[]).map(function(a){return a.replace(/["']/g,"")}),size:a.length,totalImagesSize:0,noImageSize:0,newText:"",newSize:0},c=0,b=a;e.images.forEach(function(a){c+=a.length;b=b.replace(a,"")});e.totalImagesSize=c;
e.noImageSize=b.length;g+=e.size;d+=e.noImageSize;h+=e.totalImagesSize;return e}),a=1;g>c&&(a=Math.sqrt((c-d)/h));return{infos:q,factor:a,sumSize:g}}};m.optimizeSize=function(f,c){function g(f){h++;d.infos.forEach(function(a){a.newText=a.text;a.newSize=a.size});return l(d.infos.map(function(a){return l(a.images.map(function(b){return n.scaleImage(b,{factor:d.factor*f}).then(function(e){a.newText=a.newText.replace(b,e);a.newSize=a.newText.length})})).then(function(){return a.newText})})).then(function(a){var b=
0;d.infos.forEach(function(a){b+=a.newSize});return b<=c?(console.log("SVG string has been optimized "+d.sumSize/1E6+" \x3d\x3e "+b/1E6+" Mb with "+h+" iteration(s)."),a):g(f-.1)})}if(!c)return k(f);var d=r.analyze(f,c);if(1<=d.factor)return k(f);var h=0;return g(.9)};return m});