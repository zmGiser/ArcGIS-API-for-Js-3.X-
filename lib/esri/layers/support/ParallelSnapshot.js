// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.
//>>built
define("esri/layers/support/ParallelSnapshot","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/Deferred ../../kernel".split(" "),function(f,g,h,l,m,n){f=f(null,{declaredClass:"esri.layers.support.ParallelSnapshot",layer:null,mode:null,queryTask:null,batchSize:5,_query:null,_fetchDfd:null,_startPage:null,_lastPage:null,_maxPage:null,_requests:null,constructor:function(a){g.mixin(this,a);this._requests={};this._maxPage=Math.ceil(this.mode.maxFeatures/this.layer.maxRecordCount)},destroy:function(){this.cancel()},
fetch:function(a){var c=new m;this.cancel(!0);this._query=a;this._fetchDfd=c;this._sendRequests();return c.promise},cancel:function(a){this._cancelPendingRequests(a);this._reset()},_reset:function(){this._startPage=this._lastPage=null;this._requests={}},_sendRequests:function(a){var c=this._query,b=this.queryTask,d=this._requests,k=this.layer.maxRecordCount,e;a=null==a?1:a;e=a+this.batchSize-1;e>this._maxPage&&(e=this._maxPage);if(!(a>e))for(this._startPage=a,this._lastPage=e;a<=e;a++)c.start=(a-
1)*k,c.num=k,d[a]=b.execute(c),d[a].then(g.hitch(this,this._handleSuccess,a)).otherwise(g.hitch(this,this._handleError,a))},_handleSuccess:function(a,c){c.exceededTransferLimit?a===this._lastPage&&this._sendRequests(this._lastPage+1):this._cancelLaterRequests(a,!0);var b=this.mode._checkMaxLimit(c.features);this._fetchDfd.progress(b.features);b.maxLimitReached?(b=b.featuresDiscarded,b||(b=(b=(b=(b=(b=this._getLastSuccessfulRequest())&&b.dfd)&&b.results)&&b[0])?!!b.exceededTransferLimit:!1),this._resolveFetch(b)):
this._hasPendingRequests()||this._resolveFetch(!1)},_handleError:function(a,c){var b=this._requests;b&&b[a]&&this._rejectFetch(c)},_resolveFetch:function(a){this.cancel(!0);this._fetchDfd.resolve({hasPartialFeatures:a})},_rejectFetch:function(a){this.cancel(!0);this._fetchDfd.reject(a)},_hasPendingRequests:function(){return!!this._getPendingRequests().length},_getPendingRequests:function(){var a=this._requests,c,b=[];for(c in a){var d=a[c];d.isFulfilled()||b.push({pageId:Number(c),dfd:d})}return b},
_getLastSuccessfulRequest:function(){var a=this._getResolvedRequests(),c=-Infinity,b;h.forEach(a,function(a){a.pageId>c&&(c=a.pageId,b=a)});return b},_getResolvedRequests:function(){var a=this._requests,c,b=[];for(c in a){var d=a[c];d.isResolved()&&b.push({pageId:Number(c),dfd:d})}return b},_cancelPendingRequests:function(a){this._cancelRequests(this._getPendingRequests(),a)},_cancelLaterRequests:function(a,c){var b=h.filter(this._getPendingRequests(),function(b){return b.pageId>a});this._cancelRequests(b,
c)},_cancelRequests:function(a,c){var b=this.mode,d=this._requests;h.forEach(a,function(a){c&&delete d[a.pageId];b._cancelPendingRequest(a.dfd)})}});l("extend-esri")&&g.setObject("layers.support.ParallelSnapshot",f,n);return f});